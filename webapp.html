<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .camera-view {
            position: relative;
            overflow: hidden;
        }
        .camera-view video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scan-line {
            position: absolute;
            left: 0;
            width: 150%;
            height: 7px;
            background: linear-gradient(90deg, transparent, #34d399, transparent);
            animation: scan 3s linear infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .pulse-text {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        ::-webkit-scrollbar {
            display: none;
        }
        html {
            -ms-overflow-style: none;  
            scrollbar-width: none; 
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <div id="loading-screen" class="fixed inset-0 bg-indigo-600 flex flex-col items-center justify-center z-50">
        <i class="fas fa-school text-white text-5xl mb-4"></i>
        <h1 class="text-white text-2xl font-bold pulse-text">Smart Attend is starting...</h1>
    </div>

    <main class="flex-grow overflow-y-auto pb-20 hidden">
        <div id="home-screen" class="p-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Attendance Dashboard</h1>
                    <p class="text-gray-500">Welcome, Teacher!</p>
                </div>
                <div class="p-2 bg-white rounded-full shadow-sm">
                    <i class="fas fa-school text-indigo-500 text-xl"></i>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <p class="text-3xl font-bold text-indigo-600" id="total-students">0</p>
                    <p class="text-gray-500 text-sm">Total Students</p>
                </div>
                 <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <p class="text-3xl font-bold text-green-500" id="today-present">0</p>
                    <p class="text-gray-500 text-sm">Present Today</p>
                </div>
            </div>
            
            <h2 class="text-xl font-bold text-gray-700 mt-8 mb-4">Quick Actions</h2>
            <div class="space-y-4">
                 <button onclick="app.navigate('attendance-screen')" class="w-full bg-indigo-600 text-white p-4 rounded-lg shadow-md flex items-center justify-center text-lg hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-camera mr-3"></i> 
                    Take Attendance
                </button>
                <button onclick="app.navigate('enroll-screen')" class="w-full bg-green-500 text-white p-4 rounded-lg shadow-md flex items-center justify-center text-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-user-plus mr-3"></i> 
                    Enroll Student
                </button>
                <button onclick="app.navigate('students-screen')" class="w-full bg-blue-500 text-white p-4 rounded-lg shadow-md flex items-center justify-center text-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-users mr-3"></i>
                    View Students
                </button>
                <button onclick="app.navigate('records-screen')" class="w-full bg-white text-gray-700 p-4 rounded-lg shadow-sm flex items-center justify-center text-lg border border-gray-200 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-list-alt mr-3"></i>
                    Attendance Records
                </button>
            </div>
        </div>

        
        <div id="enroll-screen" class="p-6 hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Enroll New Student</h1>
            <div class="bg-white p-4 rounded-lg shadow-sm">
                 <div class="camera-view w-5/6 mx-auto h-96 bg-gray-900 rounded-md mb-4 flex items-center justify-center">
                    <video id="enroll-video" autoplay playsinline class="rounded-md hidden"></video>
                    <p id="enroll-cam-placeholder" class="text-white">Starting Camera...</p>
                </div>
                <div class="mb-4">
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                    <input type="text" id="student-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="roll-number" class="block text-sm font-medium text-gray-700">Roll Number</label>
                    <input type="text" id="roll-number" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="enroll-button" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    ENROLL
                </button>
            </div>
        </div>

        <div id="attendance-screen" class="p-6 hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Take Attendance</h1>
             <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="camera-view w-5/6 mx-auto h-96 bg-gray-900 rounded-md mb-4 flex items-center justify-center">
                    <video id="attendance-video" autoplay playsinline class="rounded-md hidden"></video>
                     <div id="scan-line-container" class="hidden h-full w-full absolute top-0 left-0 overflow-hidden">
                        <div class="scan-line"></div>
                    </div>
                    <p id="attendance-cam-placeholder" class="text-white">Starting Camera...</p>
                </div>
                <button id="scan-button" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-qrcode mr-2"></i> 
                    MARK ATTENDANCE
                </button>
                 <div id="attendance-results" class="mt-4 hidden">
                    <h2 class="font-bold text-lg">Results: <span id="scan-status" class="font-normal text-gray-600"></span></h2>
                    <div id="present-list" class="mt-2"></div>
                </div>
            </div>
        </div>

        <div id="students-screen" class="p-6 hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Enrolled Students</h1>
            <div id="students-list" class="space-y-3">
                </div>
        </div>
        
        <div id="records-screen" class="p-6 hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Attendance Records</h1>
            <button id="clear-records-btn" class="w-full bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition-colors mb-4 flex items-center justify-center">
                <i class="fas fa-trash-alt mr-2"></i> Clear All Records
            </button>
            <div id="records-list" class="space-y-3">
                <p class="text-gray-500">No records found.</p>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around shadow-inner hidden">
        <button onclick="app.navigate('home-screen')" class="nav-btn flex-1 p-3 text-center text-indigo-600">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs block">Home</span>
        </button>
        <button onclick="app.navigate('enroll-screen')" class="nav-btn flex-1 p-3 text-center text-gray-500">
            <i class="fas fa-user-plus text-xl"></i>
            <span class="text-xs block">Enroll</span>
        </button>
        <button onclick="app.navigate('students-screen')" class="nav-btn flex-1 p-3 text-center text-gray-500">
            <i class="fas fa-users text-xl"></i>
            <span class="text-xs block">Students</span>
        </button>
        <button onclick="app.navigate('attendance-screen')" class="nav-btn flex-1 p-3 text-center text-gray-500">
            <i class="fas fa-camera text-xl"></i>
            <span class="text-xs block">Attendance</span>
        </button>
        <button onclick="app.navigate('records-screen')" class="nav-btn flex-1 p-3 text-center text-gray-500">
            <i class="fas fa-list-alt text-xl"></i>
            <span class="text-xs block">Records</span>
        </button>
    </nav>
    
    <div id="toast" class="fixed bottom-24 right-4 bg-gray-900 text-white px-5 py-2 rounded-lg shadow-xl opacity-0 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>


<script>
const app = {
    currentPage: 'home-screen',
    students: [],
    attendanceRecords: [],
    videoStream: null,

    init() {
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.querySelector('main');
        const navBar = document.querySelector('nav');

        setTimeout(() => {
            loadingScreen.style.display = 'none';
            mainContent.classList.remove('hidden');
            navBar.classList.remove('hidden');
            
            this.loadData();
            this.updateDashboard();
            this.attachEventListeners();
            this.navigate('home-screen'); 
        }, 3000);
    },

    loadData() {
        this.students = JSON.parse(localStorage.getItem('students')) || [];
        this.attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
    },

    saveData() {
        localStorage.setItem('students', JSON.stringify(this.students));
        localStorage.setItem('attendanceRecords', JSON.stringify(this.attendanceRecords));
    },

    navigate(pageId) {
        this.stopCamera();

        this.currentPage = pageId;
        document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');

        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('text-indigo-600', 'text-gray-500'));
        const activeBtn = document.querySelector(`button[onclick="app.navigate('${pageId}')"]`);
        if (activeBtn) {
            activeBtn.classList.replace('text-gray-500', 'text-indigo-600');
        }

        if (pageId === 'home-screen') this.updateDashboard();
        if (pageId === 'records-screen') this.renderRecords();
        if (pageId === 'students-screen') this.renderStudents();
        if (pageId === 'enroll-screen' || pageId === 'attendance-screen') {
            this.startCamera(pageId === 'enroll-screen' ? 'enroll-video' : 'attendance-video');
        }
    },
    
    updateDashboard() {
        document.getElementById('total-students').textContent = this.students.length;
        const today = new Date().toLocaleDateString();
        const todayRecord = this.attendanceRecords.find(r => r.date === today);
        document.getElementById('today-present').textContent = todayRecord ? todayRecord.present.length : 0;
    },

    showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0');
        setTimeout(() => {
            toast.classList.add('opacity-0');
        }, duration);
    },

    async startCamera(videoId) {
        const videoElement = document.getElementById(videoId);
        const placeholder = document.getElementById(videoId.replace('video', 'cam-placeholder'));
        
        try {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                this.videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                videoElement.srcObject = this.videoStream;
                videoElement.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                placeholder.textContent = 'Camera not supported.';
            }
        } catch (error) {
            console.error("Error accessing camera:", error);
            placeholder.textContent = 'Could not access camera.';
        }
    },

    stopCamera() {
        if (this.videoStream) {
            this.videoStream.getTracks().forEach(track => track.stop());
            this.videoStream = null;

            document.getElementById('enroll-video').classList.add('hidden');
            document.getElementById('enroll-cam-placeholder').classList.remove('hidden');
            document.getElementById('attendance-video').classList.add('hidden');
            document.getElementById('attendance-cam-placeholder').classList.remove('hidden');
        }
    },

    enrollStudent() {
        const nameInput = document.getElementById('student-name');
        const rollInput = document.getElementById('roll-number');
        const name = nameInput.value.trim();
        const roll = rollInput.value.trim();

        if (!name || !roll) {
            this.showToast('Please enter both name and roll number.');
            return;
        }

        if (this.students.some(s => s.roll === roll)) {
            this.showToast('A student with this roll number already exists.');
            return;
        }

        const newStudent = { id: Date.now(), name, roll };
        this.students.push(newStudent);
        this.saveData();
        this.showToast(`${name} has been enrolled successfully!`);
        
        nameInput.value = '';
        rollInput.value = '';
        this.updateDashboard();
    },

    takeAttendance() {
        const scanButton = document.getElementById('scan-button');
        const scanStatus = document.getElementById('scan-status');
        const resultsDiv = document.getElementById('attendance-results');
        const presentListDiv = document.getElementById('present-list');
        const scanLine = document.getElementById('scan-line-container');

        if (this.students.length === 0) {
            this.showToast('No students enrolled. Please enroll students first.');
            return;
        }

        scanButton.disabled = true;
        scanButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Scanning...';
        scanStatus.textContent = 'Scanning classroom...';
        resultsDiv.classList.remove('hidden');
        presentListDiv.innerHTML = '';
        scanLine.classList.remove('hidden');

      
        setTimeout(() => {
            const presentStudents = this.students.filter(() => Math.random() > 0.3);
            const today = new Date().toLocaleDateString();

            let todayRecord = this.attendanceRecords.find(r => r.date === today);
            if (todayRecord) {
                todayRecord.present = [...new Set([...todayRecord.present, ...presentStudents.map(s => s.id)])];
            } else {
                todayRecord = { date: today, present: presentStudents.map(s => s.id) };
                this.attendanceRecords.push(todayRecord);
            }
            
            this.saveData();

            scanStatus.textContent = `Found ${presentStudents.length} of ${this.students.length} students.`;
            presentStudents.forEach(student => {
                presentListDiv.innerHTML += `<div class="bg-green-100 text-green-800 p-2 rounded-md mt-1">${student.name} (${student.roll}) - Present</div>`;
            });
            
            if (presentStudents.length < this.students.length) {
                 const absentStudents = this.students.filter(s => !presentStudents.some(p => p.id === s.id));
                 absentStudents.forEach(student => {
                    presentListDiv.innerHTML += `<div class="bg-red-100 text-red-800 p-2 rounded-md mt-1">${student.name} (${student.roll}) - Absent</div>`;
                });
            }

            scanButton.disabled = false;
            scanButton.innerHTML = '<i class="fas fa-qrcode mr-2"></i> Scan Again';
            scanLine.classList.add('hidden');
            this.showToast('Attendance saved for today!');
            this.updateDashboard();
        }, 3000); 
    },
    clearRecords() {
        if (confirm('Are you sure you want to delete all attendance records? This action cannot be undone.')) {
            this.attendanceRecords = [];
            this.saveData();
            this.renderRecords();
            this.updateDashboard();
            this.showToast('All attendance records have been deleted.');
        }
    },

    // START: MODIFIED renderStudents function
    renderStudents() {
        const listDiv = document.getElementById('students-list');
        listDiv.innerHTML = '';

        if (this.students.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500 text-center mt-4">No students have been enrolled yet.</p>';
            return;
        }

        // Create a sorted copy of the students array by name
        const sortedStudents = [...this.students].sort((a, b) => a.name.localeCompare(b.name));

        // Loop through the new sorted array to display students
        sortedStudents.forEach(student => {
            const studentHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800">${student.name}</p>
                        <p class="text-sm text-gray-500">Roll No: ${student.roll}</p>
                    </div>
                    <button data-id="${student.id}" class="delete-student-btn text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-trash-alt fa-lg"></i>
                    </button>
                </div>
            `;
            listDiv.innerHTML += studentHTML;
        });
    },
    // END: MODIFIED renderStudents function

    deleteStudent(studentId) {
        const studentToDelete = this.students.find(s => s.id === studentId);
        if (!studentToDelete) return;

        if (confirm(`Are you sure you want to delete ${studentToDelete.name}? All their attendance records will also be removed.`)) {
            this.students = this.students.filter(s => s.id !== studentId);

            this.attendanceRecords.forEach(record => {
                record.present = record.present.filter(id => id !== studentId);
            });

            this.saveData();
            this.renderStudents();
            this.updateDashboard();
            this.showToast(`${studentToDelete.name} has been deleted.`);
        }
    },

    renderRecords() {
        const listDiv = document.getElementById('records-list');
        listDiv.innerHTML = '';

        if (this.attendanceRecords.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500 text-center mt-4">No attendance records found.</p>';
            return;
        }

        [...this.attendanceRecords].reverse().forEach(record => {
            const presentCount = record.present.length;
            const absentCount = this.students.length - presentCount;

            const recordHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-lg text-gray-800">${record.date}</p>
                        <div class="flex space-x-4">
                            <span class="text-green-600 font-semibold">Present: ${presentCount}</span>
                            <span class="text-red-600 font-semibold">Absent: ${absentCount > 0 ? absentCount : 0}</span>
                        </div>
                    </div>
                </div>
            `;
            listDiv.innerHTML += recordHTML;
        });
    },

    attachEventListeners() {
        document.getElementById('enroll-button').addEventListener('click', () => this.enrollStudent());
        document.getElementById('scan-button').addEventListener('click', () => this.takeAttendance());
        document.getElementById('clear-records-btn').addEventListener('click', () => this.clearRecords());

        document.getElementById('students-list').addEventListener('click', (event) => {
            const deleteButton = event.target.closest('.delete-student-btn');
            if (deleteButton) {
                const studentId = parseInt(deleteButton.dataset.id);
                this.deleteStudent(studentId);
            }
        });
    },
};

window.addEventListener('DOMContentLoaded', () => app.init());
</script>

</body>
</html>